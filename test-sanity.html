<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Sanity API Connection</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 900px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f5;
        }

        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #0E3A5D;
            margin-bottom: 20px;
        }

        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 600;
        }

        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }

        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 13px;
        }

        button {
            background: #FB923C;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin: 10px 5px;
        }

        button:hover {
            background: #F97316;
        }

        .protocol-check {
            font-size: 18px;
            margin: 20px 0;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üîç Test Koneksi Sanity API</h1>

        <div id="protocol-status" class="protocol-check"></div>

        <button onclick="testSanityAPI()">Test API Sanity</button>
        <button onclick="location.reload()">Refresh</button>

        <div id="result"></div>
    </div>

    <script>
        // Check current protocol
        const currentProtocol = window.location.protocol;
        const protocolDiv = document.getElementById('protocol-status');

        if (currentProtocol === 'file:') {
            protocolDiv.innerHTML = `
                <div class="status error">
                    ‚ùå MASALAH: Anda membuka file dengan protocol <strong>${currentProtocol}//</strong><br>
                    <br>
                    <strong>Ini menyebabkan CORS error!</strong><br>
                    Sanity API akan SELALU gagal jika dibuka dengan file://
                </div>
                <div class="status warning">
                    ‚ö†Ô∏è SOLUSI WAJIB:<br>
                    1. Install extension "Live Server" di VS Code<br>
                    2. Klik kanan file test-sanity.html ‚Üí "Open with Live Server"<br>
                    3. Website akan buka di http://localhost:5500<br>
                    4. Test lagi dari sana
                </div>
            `;
        } else if (currentProtocol === 'http:' || currentProtocol === 'https:') {
            protocolDiv.innerHTML = `
                <div class="status success">
                    ‚úÖ BAGUS! Protocol: <strong>${currentProtocol}//</strong><br>
                    Anda menggunakan web server, CORS seharusnya tidak masalah.
                </div>
            `;
        }

        async function testSanityAPI() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<div class="status info">‚è≥ Testing koneksi ke Sanity...</div>';

            const SANITY_CONFIG = {
                projectId: '1zvl0z92',
                dataset: 'production',
                apiVersion: '2023-05-03'
            };

            // Test 1: Fetch news
            const newsQuery = `*[_type == "news"] | order(publishedAt desc) [0...3] {
                title,
                publishedAt,
                "slug": slug.current
            }`;

            try {
                const encodedQuery = encodeURIComponent(newsQuery);
                const url = `https://${SANITY_CONFIG.projectId}.api.sanity.io/v${SANITY_CONFIG.apiVersion}/data/query/${SANITY_CONFIG.dataset}?query=${encodedQuery}`;

                console.log('Testing URL:', url);

                const response = await fetch(url);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();

                if (data.result && data.result.length > 0) {
                    resultDiv.innerHTML = `
                        <div class="status success">
                            ‚úÖ BERHASIL! API Sanity berfungsi dengan baik!<br>
                            <br>
                            Ditemukan ${data.result.length} berita:
                        </div>
                        <pre>${JSON.stringify(data.result, null, 2)}</pre>
                        <div class="status info">
                            <strong>Kesimpulan:</strong><br>
                            ‚úÖ Project ID: ${SANITY_CONFIG.projectId} - VALID<br>
                            ‚úÖ Dataset: ${SANITY_CONFIG.dataset} - VALID<br>
                            ‚úÖ API Version: ${SANITY_CONFIG.apiVersion} - VALID<br>
                            ‚úÖ Koneksi Internet - OK<br>
                            <br>
                            <strong>Jika website utama masih tidak muncul data:</strong><br>
                            Pastikan Anda membuka website dengan Live Server, bukan file://
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="status warning">
                            ‚ö†Ô∏è API berfungsi, tapi tidak ada data berita di Sanity.<br>
                            Silakan tambahkan data di Sanity Studio.
                        </div>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                }

            } catch (error) {
                console.error('Error:', error);

                let errorMessage = error.message;
                let solution = '';

                if (error.message.includes('CORS') || error.message.includes('Failed to fetch')) {
                    solution = `
                        <div class="status error">
                            <strong>PENYEBAB ERROR:</strong><br>
                            Anda masih membuka file dengan protocol <code>file://</code><br>
                            <br>
                            <strong>SOLUSI:</strong><br>
                            1. Install extension "Live Server" di VS Code<br>
                            2. Klik kanan file ini ‚Üí "Open with Live Server"<br>
                            3. Test lagi dari http://localhost:5500
                        </div>
                    `;
                }

                resultDiv.innerHTML = `
                    <div class="status error">
                        ‚ùå ERROR: ${errorMessage}
                    </div>
                    ${solution}
                    <pre>${error.stack || error}</pre>
                `;
            }
        }

        // Auto test if not file protocol
        if (currentProtocol !== 'file:') {
            testSanityAPI();
        }
    </script>
</body>

</html>